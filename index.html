<!DOCTYPE html>
<html lang="fr"> 
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>lecture - استماع وقراءة</title> <!-- Arabic UI -->
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: Arial, sans-serif; 
            direction: ltr; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            min-height: 100vh; padding: 20px; color: #333; 
            -webkit-tap-highlight-color: transparent; 
            display: flex; flex-direction: column; align-items: center; overflow-x: hidden; 
        }
        .page-content-wrapper { width: 100%; max-width: 900px; position: relative; z-index: 1; }
        h1.page-title { font-size: 2.5em; color: white; margin-top: 15px; margin-bottom: 25px; text-align: center; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3); }
        #modeSelector, #listenModeUI, #readModeUI, #sentence { background: rgba(255, 255, 255, 0.92); border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); }
        #modeSelector { display: flex; justify-content: center; gap: 15px; padding: 25px; }
        .mode-select-button { color: white; border: none; padding: 12px 25px; border-radius: 50px; font-size: 1.2em; font-weight: bold; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2); min-width: 140px; text-align: center; }
        #btnSelectListen { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        #btnSelectRead { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        .mode-select-button:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25); }
        .mode-select-button.active { background: linear-gradient(135deg, #ff6b6b 0%, #ffa726 100%) !important; box-shadow: inset 0 3px 7px rgba(0,0,0,0.2), 0 6px 15px rgba(0,0,0,0.2); transform: translateY(1px); }
        
        #listenModeUI .reader-select-group { margin-bottom: 15px; text-align: left; } 
        #listenModeUI label { font-size: 1em; margin-bottom: 5px; display: block; color: #555; }
        #listenModeUI select { font-size: 1em; padding: 10px; width:100%; border-radius: 8px; border: 1px solid #ddd; background-color: white; }
        
        .preroll-title-display { text-align: center; margin-bottom: 10px; padding-bottom: 10px; font-size: 1.1em; color: #444; }
        .preroll-words-container { text-align: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid rgba(102, 126, 234, 0.2); }

        #sentence { font-size: 30px; line-height: 2.0; text-align: left; } 

        #sentence .word-span, 
        #sentence .preroll-words-container .word-container > .word-span {
            display: inline-block; padding: 2px 4px; margin: 0 1px; border-radius: 5px; 
            vertical-align: baseline; transition: all 0.2s ease-in-out; cursor: default; visibility: hidden;
        }

        .word-container { position: relative; display: inline-block; margin: 0 2px; padding-top: 1.5em; padding-bottom: 0.5em; vertical-align: baseline; }
        
        .pronunciation-feedback { position: absolute; top: 0; left: 50%; transform: translateX(-50%); font-size: 1em; line-height: 1; visibility: hidden; font-family: Arial, sans-serif; z-index: 10; }
        .pronunciation-feedback.correct { color: green; visibility: visible; }
        .pronunciation-feedback.incorrect { color: red; visibility: visible; }

        .skip-word-button { 
            position: absolute; bottom: -0.8em; left: 50%; transform: translateX(-50%); 
            font-size: 0.8em; line-height: 1; visibility: hidden; cursor: pointer; 
            color: #ff8c00; background-color: rgba(255, 255, 255, 0.8);
            padding: 2px 5px; border-radius: 3px; border: 1px solid #ff8c00;
            font-family: Arial, sans-serif; z-index: 9;
        }
        .skip-word-button:hover { color: #e67e00; border-color: #e67e00; }

        .section-marker { color: #667eea; font-size: 0.75em; margin: 0 5px; display: inline; visibility: visible !important; } 

        .highlight-active-word { 
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%) !important; 
            color: #fff !important; transform: scale(1.05); 
            box-shadow: 0 2px 10px rgba(79, 172, 254, 0.3); 
            visibility: visible !important; opacity: 1 !important; 
        }
        .processed-word { 
            background: rgba(79, 172, 254, 0.15) !important; 
            color: #333 !important; transform: none; 
            visibility: visible !important; opacity: 1 !important; 
        }

        .read-mode-active #sentence .word-span,
        .read-mode-active #sentence .preroll-words-container .word-container > .word-span {
            visibility: visible !important; background-color: rgba(220, 220, 220, 0.15); 
            color: #555; transform: none; box-shadow: none;
        }
         .read-mode-active #sentence .preroll-title-display { visibility: visible !important; }

        .read-mode-active #sentence .word-span.highlight-active-word { 
            background: linear-gradient(135deg, #ffda79 0%, #ffb142 100%) !important;
            color: #533f00 !important; transform: scale(1.05); 
            box-shadow: 0 2px 10px rgba(255, 177, 66, 0.4);
        }
        .read-mode-active #sentence .word-span.processed-word.correct-pronunciation { 
            background: rgba(67, 233, 123, 0.25) !important; 
            color: #1d7c3d !important; transform: none; box-shadow:none; 
        }
        .read-mode-active #sentence .word-span.incorrect-pronunciation { 
            background: #ffdddd !important; color: #a94442 !important; 
            box-shadow: 0 0 5px 2px rgba(255, 0, 0, 0.5) !important; 
        }
        .read-mode-active #sentence .word-span.skipped-word {
            background-color: #e0e0e0 !important; color: #888 !important;
            text-decoration: line-through; transform: none; box-shadow: none; opacity: 0.7;
        }

        .controls { margin-top: 15px; margin-bottom: 10px; display: flex; justify-content: center; gap:15px; }
        .controls button { border: none; padding: 12px 22px; border-radius: 50px; font-size: 1.2em; /* Adjusted for Arabic potentially */ font-weight: bold; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15); min-width: 140px; /* Adjusted for Arabic */ text-align:center; color: white; }
        #listenControls button, #readControls button:not(#resetButtonRead) { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        #readControls #resetButtonRead { background: linear-gradient(135deg, #868e96 0%, #595f65 100%); }
        .controls button:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .controls button:active { transform: translateY(0px); }
        #readControls #speechButtonRead.listening { background: linear-gradient(135deg, #ff6b6b 0%, #f06595 100%) !important; animation: none !important; }
        #listenControls #playPauseButtonListen { font-size: 1.3em; padding: 10px 20px; }
        #speechStatusRead { font-size: 1.2em; color: #000000; background: rgba(255, 255, 255, 0.7); padding: 12px 20px; border-radius: 25px; min-height: 2.5em; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; line-height: 1.4; text-align: center; font-family: Arial, sans-serif; /* Ensure LTR font for status if needed */ }
        #audioPlayerListen { display: none; }
        
        #skippedWordsDisplay { 
            text-align: right; /* For Arabic heading */
            margin-top: 20px; padding: 15px; background: rgba(255, 255, 255, 0.85); 
            border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            font-family: Arial, sans-serif; color: #333;
        }
        #skippedWordsDisplay h3 {
            font-size: 1.1em; color: #d9534f; margin-bottom: 8px;
            text-align: center; font-family: 'Arial', sans-serif; /* Default font for Arabic title */
        }
        #skippedWordsDisplay ul { list-style-type: none; padding-right: 0; /* For Arabic list items (if needed) */ max-height: 150px; overflow-y: auto; text-align:left; /* Keep list items LTR */ }
        #skippedWordsDisplay li { padding: 3px 0; font-size: 1em; border-bottom: 1px dashed #eee; }
        #skippedWordsDisplay li:last-child { border-bottom: none; }

        .confetti { position: fixed; width: 10px; height: 10px; background-color: #f00; opacity: 0; z-index: 1000; animation: confetti-fall 3s ease-out forwards; }
        @keyframes confetti-fall { 0% { transform: translateY(-10vh) rotateZ(0deg); opacity: 1; } 100% { transform: translateY(110vh) rotateZ(720deg); opacity: 0; } }
        .btn-pulsing { animation: pulse-glow-red 1.5s infinite alternate; }
        @keyframes pulse-glow-red { 0% { box-shadow: 0 6px 20px rgba(0,0,0,0.15), 0 0 0 0px rgba(255,0,0,0.7); } 100% { box-shadow: 0 6px 25px rgba(0,0,0,0.25), 0 0 0 12px rgba(255,0,0,0); } }
        @media (max-width: 768px) { body { padding: 15px; } .page-content-wrapper { padding: 0; } h1.page-title { font-size: 2em; margin-bottom: 20px; } #modeSelector, #listenModeUI, #readModeUI, #sentence { padding: 15px; border-radius:12px; } #modeSelector { flex-direction: column; gap: 10px; padding: 20px; } .mode-select-button { font-size: 1.1em; padding: 12px 20px; width: 100%; max-width: 280px; margin: 0 auto; } .controls button { font-size: 1.1em; padding: 10px 18px; min-width: 120px; } #listenControls #playPauseButtonListen { font-size: 1.2em; } #sentence { font-size: 26px; line-height: 1.8; } .section-marker { font-size: 0.7em; } #speechStatusRead {font-size: 1.1em;} #skippedWordsDisplay { padding: 10px; } #skippedWordsDisplay h3 {font-size: 1em;} #skippedWordsDisplay li {font-size: 0.9em;} }
        @media (max-width: 480px) { body { padding: 10px; } h1.page-title { font-size: 1.7em; } #modeSelector, #listenModeUI, #readModeUI, #sentence { padding: 12px; border-radius:10px;} .mode-select-button { font-size: 1em; padding: 10px 15px; } .controls button { font-size: 1em; padding: 8px 15px; min-width: auto; } #listenControls #playPauseButtonListen { font-size: 1.1em; } #sentence { font-size: 22px; line-height: 1.7; } .section-marker { font-size: 0.65em; } #speechStatusRead { font-size: 1em; padding: 10px 15px; } #skippedWordsDisplay { padding: 8px; } #skippedWordsDisplay h3 {font-size: 0.95em;} #skippedWordsDisplay li {font-size: 0.85em;} }
    </style>
</head>
<body>
 <div class="page-content-wrapper">
    <h1 class="page-title">lecture</h1> 
    <div id="modeSelector">
        <button id="btnSelectListen" class="mode-select-button">🎵 اسمع</button>
        <button id="btnSelectRead" class="mode-select-button">📖 اقرأ</button>
    </div>
    <div id="listenModeUI" style="display: none;">
        <div class="reader-select-group"><label for="readerSelect">اختر القارئ:</label><select id="readerSelect"></select></div>
        <audio id="audioPlayerListen"></audio>
        <div class="controls" id="listenControls"><button id="playPauseButtonListen" class="btn-pulsing">▶️</button></div>
    </div>
    <div id="readModeUI" style="display: none;">
        <div id="speechStatusRead">اضغط "ابدأ القراءة" واقرأ</div>
        <div class="controls" id="readControls">
            <button id="speechButtonRead" class="btn-pulsing">🎤 ابدأ القراءة</button>
            <button id="resetButtonRead">🔄 إعادة</button>
        </div>
    </div>
    <div id="sentence" style="display: none;"></div>
    <div id="skippedWordsDisplay" style="display: none;"></div>
 </div>
<script>
    const SCRIPT_READERS_DATA = [
    {
        "name": "Lecteur par défaut",
        "audioFile": "farid.mp3",
        "prerollTitle": "farid",
        "prerollTimings": [],
        "ayatTimings": [
            {
                "type": "word",
                "text": "Aujourd'hui",
                "time": "0.28"
            },
            {
                "type": "word",
                "text": "Farid",
                "time": "0.91"
            },
            {
                "type": "word",
                "text": "ne",
                "time": "1.21"
            },
            {
                "type": "word",
                "text": "peut",
                "time": "1.43"
            },
            {
                "type": "word",
                "text": "pas",
                "time": "1.65"
            },
            {
                "type": "word",
                "text": "aller",
                "time": "2.0"
            },
            {
                "type": "word",
                "text": "à",
                "time": "2.13"
            },
            {
                "type": "word",
                "text": "la",
                "time": "2.32"
            },
            {
                "type": "word",
                "text": "piscine",
                "time": "2.86"
            },
            {
                "type": "word",
                "text": "Il",
                "time": "3.64"
            },
            {
                "type": "word",
                "text": "a",
                "time": "3.83"
            },
            {
                "type": "word",
                "text": "mal",
                "time": "4.14"
            },
            {
                "type": "word",
                "text": "à",
                "time": "4.31"
            },
            {
                "type": "word",
                "text": "l'oreille",
                "time": "4.85"
            },
            {
                "type": "word",
                "text": "Les",
                "time": "5.73"
            },
            {
                "type": "word",
                "text": "enfants",
                "time": "6.05"
            },
            {
                "type": "word",
                "text": "du",
                "time": "6.27"
            },
            {
                "type": "word",
                "text": "quartier",
                "time": "6.87"
            },
            {
                "type": "word",
                "text": "ont",
                "time": "7.24"
            },
            {
                "type": "word",
                "text": "une",
                "time": "7.54"
            },
            {
                "type": "word",
                "text": "compétition",
                "time": "8.47"
            },
            {
                "type": "word",
                "text": "Maman",
                "time": "9.39"
            },
            {
                "type": "word",
                "text": "donne",
                "time": "9.77"
            },
            {
                "type": "word",
                "text": "à",
                "time": "9.94"
            },
            {
                "type": "word",
                "text": "Farid",
                "time": "10.38"
            },
            {
                "type": "word",
                "text": "de",
                "time": "10.67"
            },
            {
                "type": "word",
                "text": "la",
                "time": "10.82"
            },
            {
                "type": "word",
                "text": "pâte",
                "time": "11.15"
            },
            {
                "type": "word",
                "text": "à",
                "time": "11.34"
            },
            {
                "type": "word",
                "text": "modeler",
                "time": "11.99"
            },
            {
                "type": "word",
                "text": "et",
                "time": "12.33"
            },
            {
                "type": "word",
                "text": "un",
                "time": "12.54"
            },
            {
                "type": "word",
                "text": "livre",
                "time": "12.9"
            },
            {
                "type": "word",
                "text": "d'images",
                "time": "13.4"
            },
            {
                "type": "word",
                "text": "à",
                "time": "13.73"
            },
            {
                "type": "word",
                "text": "colorier",
                "time": "14.46"
            }
        ]
    }
];
    const btnSelectListen = document.getElementById('btnSelectListen');
    const btnSelectRead = document.getElementById('btnSelectRead');
    const listenModeUI = document.getElementById('listenModeUI');
    const readModeUI = document.getElementById('readModeUI');
    const sentenceContainerShared = document.getElementById('sentence');
    const readerSelect = document.getElementById('readerSelect');
    const skippedWordsDisplay = document.getElementById('skippedWordsDisplay'); 

    let listen_words = [], read_wordSpans = []; 
    let currentActiveMode = null, currentReaderDataForListen = null; 
    let read_skippedWords = []; 

    SCRIPT_READERS_DATA.forEach((reader, index) => { const option = document.createElement('option'); option.value = index; option.textContent = reader.name; readerSelect.appendChild(option); });
    
    function generateSentenceSpans(readerData) {
        sentenceContainerShared.innerHTML = '';
        
        if (readerData.prerollTitle && readerData.prerollTitle.trim() !== '') {
            const prerollTitleDiv = document.createElement('div');
            prerollTitleDiv.classList.add('preroll-title-display');
            prerollTitleDiv.textContent = readerData.prerollTitle;
            sentenceContainerShared.appendChild(prerollTitleDiv);
        }

        const prerollWordsContainer = document.createElement('div');
        prerollWordsContainer.classList.add('preroll-words-container');
        let hasPrerollWords = false;

        if (readerData.prerollTimings && readerData.prerollTimings.length > 0) {
            hasPrerollWords = true;
            readerData.prerollTimings.forEach(item => {
                const wordContainer = document.createElement('div');
                wordContainer.classList.add('word-container');
                const wordSpan = document.createElement('span');
                wordSpan.classList.add('word-span');
                wordSpan.textContent = item.text;
                if (item.time) wordSpan.dataset.time = item.time;
                const feedbackSpan = document.createElement('span');
                feedbackSpan.classList.add('pronunciation-feedback');
                const skipButton = document.createElement('span'); 
                skipButton.classList.add('skip-word-button');
                skipButton.innerHTML = 'تخطّي ➔'; 
                skipButton.onclick = () => read_skipCurrentWord(wordSpan); 

                wordContainer.appendChild(wordSpan);
                wordContainer.appendChild(feedbackSpan);
                wordContainer.appendChild(skipButton); 
                prerollWordsContainer.appendChild(wordContainer);
            });
        }
        if(hasPrerollWords) {
            sentenceContainerShared.appendChild(prerollWordsContainer);
        } else {
            prerollWordsContainer.style.display = 'none';
        }

        let lineBuffer = [];
        readerData.ayatTimings.forEach(item => { 
            if (item.type === 'word') {
                const wordContainer = document.createElement('div');
                wordContainer.classList.add('word-container');
                const wordSpan = document.createElement('span');
                wordSpan.classList.add('word-span');
                wordSpan.textContent = item.text;
                if (item.time) wordSpan.dataset.time = item.time;
                const feedbackSpan = document.createElement('span');
                feedbackSpan.classList.add('pronunciation-feedback');
                const skipButton = document.createElement('span'); 
                skipButton.classList.add('skip-word-button');
                skipButton.innerHTML = 'تخطّي ➔'; 
                skipButton.onclick = () => read_skipCurrentWord(wordSpan); 

                wordContainer.appendChild(wordSpan);
                wordContainer.appendChild(feedbackSpan);
                wordContainer.appendChild(skipButton); 
                lineBuffer.push(wordContainer);
            } else { 
                const markerSpan = document.createElement('span');
                markerSpan.textContent = item.text;
                markerSpan.classList.add('section-marker'); 
                lineBuffer.forEach(wc => sentenceContainerShared.appendChild(wc));
                sentenceContainerShared.appendChild(markerSpan);
                lineBuffer = [];
            }
        });
        if (lineBuffer.length > 0) {
            lineBuffer.forEach(wc => sentenceContainerShared.appendChild(wc));
        }
        
        listen_words = Array.from(sentenceContainerShared.querySelectorAll(".word-span[data-time]"));
    }

    function resetAllWordStyles() {
        const interactiveSpans = Array.from(sentenceContainerShared.querySelectorAll('.word-container > .word-span'));
        interactiveSpans.forEach(span => {
            span.classList.remove('highlight-active-word', 'processed-word', 'correct-pronunciation', 'incorrect-pronunciation', 'skipped-word'); 
            span.style.cursor = 'default';
            span.style.backgroundColor = ''; span.style.color = ''; span.style.transform = ''; span.style.boxShadow = ''; span.style.textDecoration = '';
            const feedbackEl = span.parentElement.querySelector('.pronunciation-feedback');
            if (feedbackEl) { feedbackEl.textContent = ''; feedbackEl.className = 'pronunciation-feedback'; }
            const skipBtn = span.parentElement.querySelector('.skip-word-button'); 
            if (skipBtn) { skipBtn.style.visibility = 'hidden'; } 
        });
        sentenceContainerShared.querySelectorAll('.section-marker').forEach(an => an.style.visibility = 'visible'); 
        const prerollTitleDisp = sentenceContainerShared.querySelector('.preroll-title-display');
        if(prerollTitleDisp) prerollTitleDisp.style.visibility = 'hidden';
    }

    const listen_audioPlayer = document.getElementById("audioPlayerListen");
    const listen_playPauseButton = document.getElementById("playPauseButtonListen");
    let listen_isPaused = false, listen_audioWasEnded = false;
    function listen_resetHighlights() { listen_words.forEach(word => {word.classList.remove("highlight-active-word", "processed-word"); word.style.visibility = 'visible';}); listen_audioWasEnded = false; }
    function listen_toggleAudio() { if (!currentReaderDataForListen) return; if (listen_audioWasEnded) { listen_resetHighlights(); listen_audioPlayer.currentTime = 0; listen_playPauseButton.classList.add('btn-pulsing'); } if (listen_audioPlayer.paused || listen_audioPlayer.ended) { if (listen_audioPlayer.ended) { listen_audioPlayer.currentTime = 0; listen_resetHighlights(); } listen_audioPlayer.play().catch(e => console.error("Audio play error:", e)); listen_isPaused = false; listen_playPauseButton.textContent = "⏸️"; listen_playPauseButton.classList.remove('btn-pulsing'); } else { listen_audioPlayer.pause(); listen_isPaused = true; listen_playPauseButton.textContent = "▶️"; if (!listen_audioWasEnded) listen_playPauseButton.classList.add('btn-pulsing'); } }
    function listen_highlightWords() { if (listen_isPaused || listen_audioWasEnded || !currentReaderDataForListen) return; const currentTime = listen_audioPlayer.currentTime; listen_words.forEach((word, index) => { let wordTime = parseFloat(word.dataset.time); let endTime = Infinity; for (let i = index + 1; i < listen_words.length; i++) { if (listen_words[i].hasAttribute('data-time')) { endTime = parseFloat(listen_words[i].dataset.time); break; } } if (endTime === Infinity) endTime = listen_audioPlayer.duration && !isNaN(listen_audioPlayer.duration) ? listen_audioPlayer.duration : wordTime + 1.0; if (currentTime >= wordTime && currentTime < endTime) { word.classList.add("highlight-active-word"); word.classList.remove("processed-word"); } else { word.classList.remove("highlight-active-word"); if (currentTime >= endTime && wordTime < currentTime) { word.classList.add("processed-word"); } else if (currentTime < wordTime) { word.classList.remove("processed-word"); } } }); if (!listen_audioPlayer.ended && listen_audioPlayer.currentTime >= listen_audioPlayer.duration - 0.1 && listen_audioPlayer.duration > 0) { listen_playPauseButton.textContent = "🔄"; listen_audioWasEnded = true; listen_words.forEach(w => { if(w.hasAttribute('data-time') && parseFloat(w.dataset.time) <= listen_audioPlayer.currentTime) { w.classList.add('processed-word'); w.classList.remove('highlight-active-word'); } }); listen_playPauseButton.classList.add('btn-pulsing'); } }
    function setupListenModeForReader(readerIndex) { currentReaderDataForListen = SCRIPT_READERS_DATA[readerIndex]; if (!currentReaderDataForListen) return; listen_audioPlayer.src = currentReaderDataForListen.audioFile; listen_audioPlayer.pause(); listen_audioPlayer.currentTime = 0; listen_isPaused = true; listen_audioWasEnded = false; listen_playPauseButton.textContent = "▶️"; listen_playPauseButton.classList.add('btn-pulsing'); generateSentenceSpans(currentReaderDataForListen); resetAllWordStyles(); 
        const allTextSpans = sentenceContainerShared.querySelectorAll('.word-container > .word-span, .section-marker'); 
        allTextSpans.forEach(span => { span.style.visibility = 'visible'; if (!span.classList.contains('section-marker')) span.style.cursor = 'pointer';}); 
        const prerollTitleDisp = sentenceContainerShared.querySelector('.preroll-title-display');
        if(prerollTitleDisp) prerollTitleDisp.style.visibility = 'visible';
        listen_words.forEach(word => { word.onclick = function() { if (listen_audioWasEnded) { listen_resetHighlights(); listen_audioWasEnded = false; listen_playPauseButton.classList.add('btn-pulsing');} listen_audioPlayer.currentTime = parseFloat(this.dataset.time); listen_highlightWords(); if (listen_audioPlayer.paused || listen_audioPlayer.ended) { listen_audioPlayer.play().catch(e => console.error("Audio play error:", e)); listen_isPaused = false; listen_playPauseButton.textContent = "⏸️"; listen_playPauseButton.classList.remove('btn-pulsing'); } }; }); 
    }
    function initListenMode() { 
        listenModeUI.style.display = 'block'; sentenceContainerShared.style.display = 'block'; 
        sentenceContainerShared.classList.remove('read-mode-active'); 
        skippedWordsDisplay.style.display = 'none'; 
        const readerSelectGroup = document.querySelector('#listenModeUI .reader-select-group'); 
        if (SCRIPT_READERS_DATA.length <= 1) { if (readerSelectGroup) readerSelectGroup.style.display = 'none'; if (SCRIPT_READERS_DATA.length === 1) setupListenModeForReader(0); else sentenceContainerShared.innerHTML = "<p>لا توجد بيانات قارئ.</p>"; } 
        else { if (readerSelectGroup) readerSelectGroup.style.display = 'block'; readerSelect.value = "0"; setupListenModeForReader(0); } 
        listen_playPauseButton.onclick = listen_toggleAudio; listen_audioPlayer.ontimeupdate = listen_highlightWords; 
        listen_audioPlayer.onended = () => { listen_playPauseButton.textContent = "🔄"; listen_isPaused = true; listen_audioWasEnded = true; listen_words.forEach(w => { if (w.classList.contains('highlight-active-word')) {w.classList.remove('highlight-active-word'); w.classList.add('processed-word');} else if (w.hasAttribute('data-time') && parseFloat(w.dataset.time) <= listen_audioPlayer.currentTime) {w.classList.add('processed-word');}}); listen_playPauseButton.classList.add('btn-pulsing'); }; 
        listen_audioPlayer.onplay = () => { listen_isPaused = false; listen_highlightWords(); listen_playPauseButton.classList.remove('btn-pulsing'); }; 
        listen_audioPlayer.onpause = () => { if(!listen_audioWasEnded && listen_isPaused) listen_playPauseButton.classList.add('btn-pulsing'); };
        listen_audioPlayer.onseeked = listen_highlightWords; readerSelect.onchange = (e) => setupListenModeForReader(parseInt(e.target.value)); 
    }
    function deactivateListenMode() { if (listen_audioPlayer && !listen_audioPlayer.paused) listen_audioPlayer.pause(); listen_playPauseButton.textContent = "▶️"; listen_playPauseButton.classList.remove('btn-pulsing'); listenModeUI.style.display = 'none'; listen_playPauseButton.onclick = null; listen_audioPlayer.ontimeupdate = null; listen_audioPlayer.onended = null; listen_audioPlayer.onplay = null; listen_audioPlayer.onseeked = null; listen_audioPlayer.onpause = null; readerSelect.onchange = null; if (Array.isArray(listen_words)) listen_words.forEach(word => {word.onclick = null; word.style.visibility='hidden';}); const prerollTitleDisp = sentenceContainerShared.querySelector('.preroll-title-display'); if(prerollTitleDisp) prerollTitleDisp.style.visibility = 'hidden'; currentReaderDataForListen = null; }

    const read_speechButton = document.getElementById("speechButtonRead");
    const read_speechStatus = document.getElementById("speechStatusRead");
    const read_resetButton = document.getElementById("resetButtonRead");
    let read_currentWordIndex = 0, read_isRecognizing = false;
    let read_finalTranscriptBuffer = ""; // Buffer for final results
    let read_processingTimeout = null; // Timeout for processing the buffer
    const PROCESSING_DELAY = 750; // Milliseconds to wait for more speech before processing

    let read_shouldRestart = false, read_restartTimeout, read_silenceTimeout, read_recognition;

    function read_normalizeText(text) { 
        if (!text) return ""; 
        return text.trim().toLowerCase(); 
    }
    
    function triggerConfettiEffect() { 
        const confettiCount = 100; 
        const confettiColors = ['#f44336', '#e91e63', '#9c27b0', '#673ab7', '#3f51b5', '#2196f3', '#03a9f4', '#00bcd4', '#009688', '#4CAF50', '#8BC34A', '#CDDC39', '#FFEB3B', '#FFC107', '#FF9800']; 
        for (let i = 0; i < confettiCount; i++) { 
            const confetti = document.createElement('div'); 
            confetti.classList.add('confetti'); 
            confetti.style.left = Math.random() * 100 + 'vw'; 
            confetti.style.backgroundColor = confettiColors[Math.floor(Math.random() * confettiColors.length)]; 
            confetti.style.animationDelay = Math.random() * 0.5 + 's'; 
            confetti.style.width = (Math.random() * 8 + 5) + 'px'; 
            confetti.style.height = confetti.style.width; 
            confetti.style.transform = `translateY(-10vh) rotateZ(${Math.random() * 360}deg)`; 
            document.body.appendChild(confetti); 
            setTimeout(() => { if (confetti.parentNode) { confetti.parentNode.removeChild(confetti); } }, 3500); 
        } 
    }

    function read_updateSkippedWordsDisplay() {
        if (!skippedWordsDisplay) return;
        if (read_skippedWords.length > 0) {
            skippedWordsDisplay.style.display = 'block';
            let content = '<h3>كلمات لم تُنطق بشكل صحيح وتم تخطيها:</h3><ul>'; 
            read_skippedWords.forEach((wordText, index) => {
                content += `<li>${index + 1}. ${wordText}</li>`;
            });
            content += '</ul>';
            skippedWordsDisplay.innerHTML = content;
        } else {
            skippedWordsDisplay.style.display = 'none';
            skippedWordsDisplay.innerHTML = '';
        }
    }
    
    function read_skipCurrentWord(wordSpanToSkip) {
        if (!wordSpanToSkip || read_currentWordIndex >= read_wordSpans.length) return;

        if (!read_skippedWords.includes(wordSpanToSkip.textContent)) {
             read_skippedWords.push(wordSpanToSkip.textContent);
        }
        read_updateSkippedWordsDisplay();

        wordSpanToSkip.classList.remove('highlight-active-word', 'incorrect-pronunciation', 'correct-pronunciation', 'processed-word');
        wordSpanToSkip.classList.add('skipped-word');
        
        const feedbackEl = wordSpanToSkip.parentElement.querySelector('.pronunciation-feedback');
        if (feedbackEl) { feedbackEl.textContent = ''; feedbackEl.className = 'pronunciation-feedback'; }
        
        const skipBtn = wordSpanToSkip.parentElement.querySelector('.skip-word-button');
        if (skipBtn) { skipBtn.style.visibility = 'hidden'; }

        read_currentWordIndex++;
        // Clear any pending processing and buffer because we are changing state abruptly
        if(read_processingTimeout) clearTimeout(read_processingTimeout);
        read_processingTimeout = null;
        read_finalTranscriptBuffer = "";

        if (read_currentWordIndex < read_wordSpans.length) {
            read_speechStatus.textContent = "تم التخطي. الكلمة التالية..."; 
            const nextWordSpan = read_wordSpans[read_currentWordIndex];
            if (nextWordSpan) {
                nextWordSpan.classList.add('highlight-active-word');
                const nextFeedbackEl = nextWordSpan.parentElement.querySelector('.pronunciation-feedback');
                if (nextFeedbackEl) { nextFeedbackEl.textContent = ''; nextFeedbackEl.className = 'pronunciation-feedback';}
                const nextSkipBtn = nextWordSpan.parentElement.querySelector('.skip-word-button');
                if (nextSkipBtn) { nextSkipBtn.style.visibility = 'hidden'; } 
            }
             if (read_isRecognizing) { 
                read_recognition.stop(); // Will trigger onend, which handles restart
            }
        } else { // All words completed, last one by skipping
            read_speechStatus.textContent = "🎉 أحسنت! لقد أكملت النص (مع بعض التجاوزات). 🎉"; 
            triggerConfettiEffect(); 
            read_shouldRestart = false; // Ensure it doesn't try to restart
            if (read_isRecognizing) {
                 read_recognition.stop();
            } else {
                 read_updateUIForStopped(); 
            }
            read_speechButton.classList.remove('btn-pulsing');
        }
    }

    function processFinalTranscript(transcriptToProcess) {
        if (transcriptToProcess && read_currentWordIndex < read_wordSpans.length) {
            const wordsToProcess = transcriptToProcess.trim().split(" ").filter(w => w.length > 0);

            for (let spokenWord of wordsToProcess) {
                if (read_currentWordIndex >= read_wordSpans.length) break;

                const normalizedSpokenWord = read_normalizeText(spokenWord);
                if (!normalizedSpokenWord) continue;

                const targetWordSpan = read_wordSpans[read_currentWordIndex];
                if (!targetWordSpan || targetWordSpan.classList.contains('skipped-word')) {
                    continue; 
                }
                if (!targetWordSpan.parentElement || !targetWordSpan.parentElement.classList.contains('word-container')) continue;

                const feedbackEl = targetWordSpan.parentElement.querySelector('.pronunciation-feedback');
                const skipBtn = targetWordSpan.parentElement.querySelector('.skip-word-button');
                const targetWordText = targetWordSpan.dataset.word;

                if (targetWordText && normalizedSpokenWord === targetWordText) { // CORRECT
                    if (feedbackEl) { feedbackEl.textContent = '✔'; feedbackEl.className = 'pronunciation-feedback correct'; }
                    if (skipBtn) { skipBtn.style.visibility = 'hidden'; }
                    targetWordSpan.classList.remove('highlight-active-word', 'incorrect-pronunciation', 'skipped-word');
                    targetWordSpan.classList.add('processed-word', 'correct-pronunciation');
                    read_currentWordIndex++;
                    if (read_currentWordIndex < read_wordSpans.length) {
                        read_speechStatus.textContent = "ممتاز! الكلمة التالية...";
                        const nextWordSpan = read_wordSpans[read_currentWordIndex];
                        if (nextWordSpan) {
                            nextWordSpan.classList.add('highlight-active-word');
                            const nextFeedbackEl = nextWordSpan.parentElement.querySelector('.pronunciation-feedback');
                            if (nextFeedbackEl) { nextFeedbackEl.textContent = ''; nextFeedbackEl.className = 'pronunciation-feedback';}
                            const nextSkipBtn = nextWordSpan.parentElement.querySelector('.skip-word-button');
                            if (nextSkipBtn) { nextSkipBtn.style.visibility = 'hidden'; }
                        }
                    }
                } else if (targetWordText) { // INCORRECT
                    if (feedbackEl) { feedbackEl.textContent = '❌'; feedbackEl.className = 'pronunciation-feedback incorrect';}
                    if (skipBtn) { skipBtn.style.visibility = 'visible'; }
                    targetWordSpan.classList.remove('correct-pronunciation', 'processed-word', 'skipped-word');
                    targetWordSpan.classList.add('incorrect-pronunciation', 'highlight-active-word');
                    read_speechStatus.textContent = `حاول مرة أخرى: "${targetWordSpan.textContent}" أو تخط الكلمة`;
                    break; 
                }
            }

            if (read_currentWordIndex >= read_wordSpans.length) {
                if (read_skippedWords.length === 0) {
                     read_speechStatus.textContent = "🎉 أحسنت! لقد أكملت النص. 🎉";
                } else {
                     read_speechStatus.textContent = "🎉 جيد! أكملت النص مع بعض التجاوزات. 🎉";
                }
                triggerConfettiEffect();
                read_shouldRestart = false;
                read_speechButton.classList.remove('btn-pulsing');
                if (read_isRecognizing) { // If completed during active recognition (not via onend from stop button)
                    read_recognition.stop(); // This will trigger onend, which will call updateUIForStopped
                }
            }
        }
    }

    const SpeechRecognitionAPI = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (SpeechRecognitionAPI) { 
        read_recognition = new SpeechRecognitionAPI(); 
        read_recognition.continuous = true; 
        read_recognition.interimResults = true; 
        read_recognition.lang = 'fr-FR'; 
        
        read_recognition.onstart = () => { 
            read_isRecognizing = true; 
            read_finalTranscriptBuffer = ""; // Clear buffer at start
            read_speechButton.textContent = "🔴 جاري القراءة..."; 
            read_speechButton.classList.add('listening'); 
            read_speechButton.classList.remove('btn-pulsing'); 
            read_speechStatus.textContent = "اقرأ الآن..."; 
            if (read_restartTimeout) clearTimeout(read_restartTimeout); 
            if (read_silenceTimeout) clearTimeout(read_silenceTimeout); 
            if (read_processingTimeout) clearTimeout(read_processingTimeout); // Clear processing timeout too
            read_restartTimeout = null; 
            read_silenceTimeout = null; 
            read_processingTimeout = null;
        };

        read_recognition.onend = () => { 
            read_isRecognizing = false; // Set this first
            if (read_restartTimeout) clearTimeout(read_restartTimeout); 
            if (read_silenceTimeout) clearTimeout(read_silenceTimeout); 
            read_restartTimeout = null; 
            read_silenceTimeout = null; 

            if (read_processingTimeout) { // If a processing timeout was pending
                clearTimeout(read_processingTimeout);
                read_processingTimeout = null;
                // Process immediately what was buffered
                if (read_finalTranscriptBuffer.trim() !== "") {
                    processFinalTranscript(read_finalTranscriptBuffer);
                }
            } else if (read_finalTranscriptBuffer.trim() !== "") {
                 // If no timeout was pending, but buffer has content (e.g. quick stop)
                 processFinalTranscript(read_finalTranscriptBuffer);
            }
            read_finalTranscriptBuffer = ""; // Always clear buffer after handling onend

            if (read_shouldRestart && read_currentWordIndex < read_wordSpans.length) { 
                read_restartTimeout = setTimeout(() => { 
                    if (!read_isRecognizing && read_shouldRestart && read_currentWordIndex < read_wordSpans.length) { 
                        try { read_recognition.start(); } 
                        catch (e) { read_shouldRestart = false; read_updateUIForStopped(); } 
                    } 
                }, 100); 
            } else { 
                read_updateUIForStopped(); 
            } 
        };

        function read_updateUIForStopped() { 
            read_speechButton.textContent = "🎤 ابدأ القراءة"; 
            read_speechButton.classList.remove('listening'); 
            if (read_currentWordIndex < read_wordSpans.length) { 
                read_speechButton.classList.add('btn-pulsing'); 
            } else { 
                read_speechButton.classList.remove('btn-pulsing'); 
            } 
            if (read_currentWordIndex < read_wordSpans.length && read_currentWordIndex > 0) { 
                read_speechStatus.textContent = "توقفت القراءة. اضغط لمتابعة."; 
            } else if (read_currentWordIndex === 0) { 
                read_speechStatus.textContent = 'اضغط "ابدأ القراءة" واقرأ'; 
            } 
            // Completion message is handled by processFinalTranscript or skipWord
        }

        read_recognition.onerror = (event) => { 
            let errorMsg = "خطأ في التعرف: " + event.error; 
            if (event.error === 'aborted' && read_shouldRestart) return; 
            if (event.error === 'no-speech' && read_shouldRestart && read_currentWordIndex < read_wordSpans.length) { 
                // No-speech can trigger onend, which will handle restart.
                // Avoid showing error if it's just a natural pause leading to no-speech.
                return; 
            } 
            // For other errors, or if not expecting a restart
            read_speechStatus.textContent = errorMsg; 
            read_isRecognizing = false; // Ensure state is correct
            // Clear timeouts and buffer as an error likely means current attempt is over
            if (read_processingTimeout) clearTimeout(read_processingTimeout);
            read_processingTimeout = null;
            read_finalTranscriptBuffer = "";
            read_updateUIForStopped(); 
        };
        
        read_recognition.onresult = (event) => { 
            if (read_silenceTimeout) clearTimeout(read_silenceTimeout); 
            read_silenceTimeout = null; 
            
            let interimTranscript = ''; 
            for (let i = event.resultIndex; i < event.results.length; ++i) { 
                const transcriptPart = event.results[i][0].transcript; 
                if (event.results[i].isFinal) {
                    read_finalTranscriptBuffer += transcriptPart + " "; 
                } else {
                    interimTranscript += transcriptPart;
                }
            } 
            
            if (interimTranscript && read_isRecognizing) { 
                read_speechStatus.textContent = "لحظة... " + interimTranscript; 
                read_silenceTimeout = setTimeout(() => { 
                    if (read_isRecognizing && read_shouldRestart && read_currentWordIndex < read_wordSpans.length) {
                        read_speechStatus.textContent = "في انتظار الكلمة التالية..."; 
                    }
                }, 3000); 
            } 
            
            if (read_finalTranscriptBuffer.trim() !== "" && read_isRecognizing) {
                if (read_processingTimeout) clearTimeout(read_processingTimeout);
                read_processingTimeout = setTimeout(() => {
                    const transcriptToProcessNow = read_finalTranscriptBuffer;
                    read_finalTranscriptBuffer = ""; // Clear buffer for next accumulation
                    
                    if (read_isRecognizing) { // Process only if still in recognizing state
                        processFinalTranscript(transcriptToProcessNow);
                    }
                    read_processingTimeout = null; // Mark as processed/timeout completed
                }, PROCESSING_DELAY);
            }
        };
    }
    
    function read_toggleSpeechRecognition() { 
        if (!SpeechRecognitionAPI) return; 
        if (read_isRecognizing || read_shouldRestart) { // User wants to stop
            read_shouldRestart = false; 
            if (read_restartTimeout) clearTimeout(read_restartTimeout); 
            if (read_silenceTimeout) clearTimeout(read_silenceTimeout); 
            read_restartTimeout = null; 
            read_silenceTimeout = null; 
            
            if (read_processingTimeout) { // If a timeout is pending
                clearTimeout(read_processingTimeout);
                read_processingTimeout = null;
                // Process any buffered content immediately before stopping
                if (read_finalTranscriptBuffer.trim() !== "") {
                     processFinalTranscript(read_finalTranscriptBuffer);
                }
            }
            read_finalTranscriptBuffer = ""; // Clear buffer

            if (read_isRecognizing) {
                read_recognition.stop(); // This will trigger 'onend'
            } else {
                // If not recognizing but shouldRestart was true (e.g. stuck in a loop), update UI
                read_updateUIForStopped();
            }
        } else { // User wants to start
            if (read_currentWordIndex >= read_wordSpans.length) read_resetActivity(); 
            read_shouldRestart = true; 
            read_speechButton.classList.remove('btn-pulsing');
            try { 
                if (read_currentWordIndex < read_wordSpans.length) { 
                    const currentTargetSpan = read_wordSpans[read_currentWordIndex]; 
                    if (currentTargetSpan && !currentTargetSpan.classList.contains('processed-word') && !currentTargetSpan.classList.contains('highlight-active-word') && !currentTargetSpan.classList.contains('skipped-word')) { 
                        currentTargetSpan.classList.add('highlight-active-word'); 
                        const feedbackEl = currentTargetSpan.parentElement.querySelector('.pronunciation-feedback');
                        if (feedbackEl) { feedbackEl.textContent = ''; feedbackEl.className = 'pronunciation-feedback';}
                        const skipBtn = currentTargetSpan.parentElement.querySelector('.skip-word-button');
                        if (skipBtn) { skipBtn.style.visibility = 'hidden'; } 
                    } 
                } 
                read_recognition.start(); 
            } catch (e) { 
                read_shouldRestart = false; 
                read_isRecognizing = false; // Ensure this is false if start fails
                read_updateUIForStopped(); 
            } 
        } 
    }
    function read_resetActivity() { 
        read_currentWordIndex = 0; 
        read_finalTranscriptBuffer = ""; // Clear the buffer
        read_shouldRestart = false; 
        read_skippedWords = []; 
        read_updateSkippedWordsDisplay(); 

        if (read_restartTimeout) clearTimeout(read_restartTimeout); 
        if (read_silenceTimeout) clearTimeout(read_silenceTimeout); 
        if (read_processingTimeout) clearTimeout(read_processingTimeout); // Clear processing timeout
        read_restartTimeout = null; 
        read_silenceTimeout = null; 
        read_processingTimeout = null;
        
        resetAllWordStyles(); 

        read_wordSpans.forEach(span => {
            span.style.visibility = 'visible';
        });
        
        const prerollTitleDisp = sentenceContainerShared.querySelector('.preroll-title-display');
        if(prerollTitleDisp) prerollTitleDisp.style.visibility = 'visible';
        
        if (read_wordSpans.length > 0) { 
            const firstWord = read_wordSpans[0]; 
            if (firstWord) { 
                firstWord.classList.add('highlight-active-word'); 
                const feedbackEl = firstWord.parentElement.querySelector('.pronunciation-feedback');
                if (feedbackEl) { feedbackEl.textContent = ''; feedbackEl.className = 'pronunciation-feedback';}
                const skipBtn = firstWord.parentElement.querySelector('.skip-word-button'); 
                if (skipBtn) { skipBtn.style.visibility = 'hidden'; } 
            } 
        } 
        read_speechStatus.textContent = 'اضغط "ابدأ القراءة" واقرأ'; 
        if (read_isRecognizing) {
             read_recognition.stop(); // Will trigger onend and then updateUIForStopped
        } else {
             read_updateUIForStopped();
        }
    }
    function initReadMode() { 
        readModeUI.style.display = 'block'; 
        sentenceContainerShared.style.display = 'block'; 
        sentenceContainerShared.classList.add('read-mode-active'); 
        read_speechButton.classList.add('btn-pulsing');
        read_updateSkippedWordsDisplay(); 
        
        if (SCRIPT_READERS_DATA.length > 0) {
            // Assuming only one reader for read mode, or using the first one
            generateSentenceSpans(SCRIPT_READERS_DATA[0]); 
            read_wordSpans = Array.from(sentenceContainerShared.querySelectorAll('.word-container > .word-span')); 
        } else { 
            sentenceContainerShared.innerHTML = "<p>لم يتم تكوين نص.</p>"; 
            read_wordSpans = []; 
        } 

        if (!SpeechRecognitionAPI) { 
            read_speechButton.disabled = true; 
            read_speechButton.textContent = "غير مدعوم"; 
            read_resetButton.disabled = true; 
            read_speechStatus.textContent = "التعرف الصوتي غير مدعوم."; 
            return; 
        } else { 
            read_speechButton.disabled = false; 
            read_resetButton.disabled = false; 
        } 
        
        read_wordSpans.forEach(span => { 
            span.dataset.word = read_normalizeText(span.textContent); 
            span.style.cursor = 'default'; 
        }); 
        read_resetActivity(); 
        read_speechButton.onclick = read_toggleSpeechRecognition; 
        read_resetButton.onclick = read_resetActivity; 
    }
    function deactivateReadMode() { 
        if (SpeechRecognitionAPI && read_recognition && (read_isRecognizing || read_shouldRestart)) { 
            read_shouldRestart = false; // Prevent restart attempts after deactivation
            if (read_isRecognizing) {
                read_recognition.stop(); 
            }
        } 
        if (read_restartTimeout) clearTimeout(read_restartTimeout); 
        if (read_silenceTimeout) clearTimeout(read_silenceTimeout); 
        if (read_processingTimeout) clearTimeout(read_processingTimeout);
        read_restartTimeout = null; 
        read_silenceTimeout = null; 
        read_processingTimeout = null;
        read_finalTranscriptBuffer = ""; // Clear buffer

        readModeUI.style.display = 'none'; 
        skippedWordsDisplay.style.display = 'none'; 
        sentenceContainerShared.classList.remove('read-mode-active');
        const allTextSpans = sentenceContainerShared.querySelectorAll('.word-container > .word-span, .preroll-title-display');
        allTextSpans.forEach(span => span.style.visibility = 'hidden');
        read_speechButton.onclick = null; 
        read_resetButton.onclick = null; 
        read_speechButton.classList.remove('btn-pulsing'); 
    }

    function switchToMode(mode) { 
        if (currentActiveMode === 'listen') deactivateListenMode(); 
        else if (currentActiveMode === 'read') deactivateReadMode(); 
        
        btnSelectListen.classList.remove('active'); 
        btnSelectRead.classList.remove('active'); 
        
        if (mode === 'listen') { 
            initListenMode(); btnSelectListen.classList.add('active'); currentActiveMode = 'listen'; 
        } else if (mode === 'read') { 
            initReadMode(); btnSelectRead.classList.add('active'); currentActiveMode = 'read'; 
        } else { 
            listenModeUI.style.display = 'none'; readModeUI.style.display = 'none'; 
            skippedWordsDisplay.style.display = 'none'; 
            if (sentenceContainerShared) {
                sentenceContainerShared.style.display = 'none';
                sentenceContainerShared.classList.remove('read-mode-active');
            }
            currentActiveMode = null; 
        } 
    }
    btnSelectListen.addEventListener('click', () => switchToMode('listen'));
    btnSelectRead.addEventListener('click', () => switchToMode('read'));
    
    if (SCRIPT_READERS_DATA && SCRIPT_READERS_DATA.length > 0) {
        switchToMode('listen'); // Default to listen mode if data exists
    } else {
        sentenceContainerShared.innerHTML = '<p style="text-align:center; color:white;">لا توجد بيانات قارئ متاحة.</p>'; 
        sentenceContainerShared.style.display = 'block';
    }
</script>
</body>
</html>